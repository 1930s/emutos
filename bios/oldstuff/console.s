
; ===========================================================================
; ==== stonx.a - Emulator specific startup module.  To be linked in first!
; ===========================================================================

; ===========================================================================
; ==== Textsegment ==========================================================
; ===========================================================================

       	.text


; ==== References ===========================================================

        .xdef	init_console	; 
        .xdef	output_word	; 
        .xdef	output_string	; 
        


; ==== Defines ==============================================================


; ==== Initialize console ===================================================
; Parameters are 
;   in:	  0x44e :	video ram address.
;	  0x44c :	resolution

init_console:
	movem.l d0/a0-a1, -(sp)

	move.b 0x44f, 0xffff8201
	move.b 0x450, 0xffff8203
	
	; initialize color palette
	move.b #2, 0xffff820a
	lea 0xffff8240,a0
	lea color_palette,a1
	move.w #15,d0
	
color_loop:	
	move.w (a1)+,(a0)+
	dbra d0,color_loop

	bsr clear_screen
	movem.l (sp)+, d0/a0-a1
	rts

clear_screen:
	movem.l d0-d1/a0, -(sp)
	
	move.l 0x44e.w, a0
	move.w #0x7ff, d0
	clr.l d1
clear_screen_loop:
	move.l d1,(a0)+
	move.l d1,(a0)+
	move.l d1,(a0)+
	move.l d1,(a0)+
	dbra d0, clear_screen_loop

	;reset cursor position
	clr.w 0x410.w	; row
	clr.w 0x412.w	; col
	move.l 0x44e.w,0x414.w	; pointer
	movem.l (sp)+,d0-d1/a0
	rts


; ==== Output a hexadecimal word ============================================
output_word:
	movem.l d0-d2/a0, -(sp)
	move.l #3,d2
	lea digits,a0
	move.w d0,d1
word_loop:	
	rol.w #4,d1
	move.w d1,d0
	and.w #0x000f,d0
	move.b 0(a0,d0.w),d0
	and.w #0x007f,d0
	bsr serial_one_char
	bsr output_one_char
	dbra d2,word_loop
	movem.l (sp)+, d0-d2/a0
	rts	
	
; ==== Output a string ======================================================
;     String address on stack, string ending with 0:
	; 12(sp):	addr
	; 8(sp):	pc
	; 4(sp):	d0
	; (sp):		a0

output_string:
	movem.l d0/a0, -(sp)
	move.l 12(sp),a0
	move.l #0,d0
	bra string_start
string_loop:	
	bsr output_one_char
string_start:	
	move.b (a0)+,d0
	beq string_end
	and.w #0x007f,d0
	bsr serial_one_char
	cmp.b #10,d0
	bne string_loop
; carriage return:
	add.w #1,0x410.w
	clr.w 0x412.w
	clr.l d0
	move.w 0x410.w,d0
	mulu #1280,d0
	add.l 0x44e.w,d0
	move.l d0, 0x414.w
	bra string_start
string_end:	
	movem.l (sp)+,d0/a0
	rts
	
        
; ==== Output a character on serial line ====================================
; Character is in d0	

serial_one_char:
	move.b d0,0xfffffa2f
serial_wait:
	tst.b 0xfffffa2d
	bpl serial_wait
	rts

	;
	; output_one_char :	char number d0, must be < 127.
	; nothing done if last line reached.
	;
	
; ==== Output a character on console window =================================
; Output_one_char :	char number d0, must be < 127.
; Nothing done if last line reached.
output_one_char:
	movem.l d0-d2/a0-a1, -(sp)
	move.l 0x414.w, a0
	lea the_font,a1
	lsl.w #3,d0
	add.w d0,a1
	tst.w 0x44c
	bne mono_char
; color rez 0
	move.l #7,d1
color_char_loop:	
	move.b (a1)+, d0

	; with movep:	
	; move.b d0,d2
	; lsr.w #8,d2
	; move.b d0,d2
	; move.w d2,d0
	; swap d0
	; move.w d2,d0
	; movep.l d0, (a0)
	
	move.b d0,(a0)
	move.b d0,2(a0)
	move.b d0,4(a0)
	move.b d0,6(a0)
	add.l #160, a0
	dbra d1,color_char_loop

	; update cursor position
	move.w 0x412.w,d0	; col
	add.l #1,d0
	btst #0,d0
	beq now_even
; now odd col position
	add.l #1,0x414.w
	bra now_odd_or_even
now_even:	
	add.l #7,0x414.w
	cmp.w #40,d0
	blt now_odd_or_even
; end of line, wrap to next line
	add.l #1120,0x414.w
	clr.w d0
	add.w #1,0x410.w	; row
now_odd_or_even:
	move.w d0,0x412.w
	movem.l (sp)+,d0-d2/a0-a1
	rts

mono_char:
	move.l #7,d1
mono_char_loop:
	move.b (a1)+,d0
	move.b d0, (a0)
	move.b d0, 160(a0)
	add.w #320, a0
	dbra d1,mono_char_loop
	move.w 0x412,d0
	add.l #1,d0
	cmp.w #80,d0
	bne no_next_line
; next line
	clr.w d0
	add.w #1,0x410
	add.l #1120,0x414.w
no_next_line:	
	move.w d0,0x412
	movem.l (sp)+,d0-d2/a0-a1
	rts


; ===========================================================================
; ==== Datasegment ==========================================================
; ===========================================================================
	.data
	.even
        
color_palette:	
	.dc.w 0x777, 0x700, 0x070, 0x770
	.dc.w 0x007, 0x707, 0x077, 0x555
	.dc.w 0x333, 0x733, 0x373, 0x773
	.dc.w 0x337, 0x737, 0x377, 0x000
	
the_font:
	.dc.b 	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	.dc.b 	0x18,0x3C,0x66,0xC3,0xE7,0x24,0x24,0x3C
	.dc.b 	0x3C,0x24,0x24,0xE7,0xC3,0x66,0x3C,0x18
	.dc.b 	0x18,0x1C,0xF6,0x83,0x83,0xF6,0x1C,0x18
	.dc.b 	0x18,0x38,0x6F,0xC1,0xC1,0x6F,0x38,0x18
	.dc.b 	0x3C,0x99,0xC3,0xE7,0xC3,0x99,0x3C,0x00
	.dc.b 	0xFF,0xFF,0xFE,0xFC,0xF9,0xF3,0xE7,0x00
	.dc.b 	0xE7,0xC3,0x99,0x3C,0x99,0xC3,0xE7,0x00
	.dc.b 	0x01,0x03,0x06,0x8C,0xD8,0x70,0x20,0x00
	.dc.b 	0x7E,0xC3,0xD3,0xD3,0xDB,0xC3,0xC3,0x7E
	.dc.b 	0x18,0x3C,0x3C,0x3C,0x7E,0x10,0x38,0x10
	.dc.b 	0x18,0x1C,0x16,0x10,0x10,0x70,0xF0,0x60
	.dc.b 	0xF0,0xC0,0xFE,0xD8,0xDE,0x18,0x18,0x00
	.dc.b 	0xF0,0xC0,0xDF,0xDB,0xFF,0x1E,0x1B,0x00
	.dc.b 	0x05,0x05,0x05,0x0D,0x0D,0x19,0x79,0x71
	.dc.b 	0xA0,0xA0,0xA0,0xB0,0xB0,0x98,0x9E,0x8E
	.dc.b	0x7C,0xC6,0xC6,0x00,0xC6,0xC6,0x7C,0x00
	.dc.b 	0x06,0x06,0x06,0x00,0x06,0x06,0x06,0x00
	.dc.b 	0x7C,0x06,0x06,0x7C,0xC0,0xC0,0x7C,0x00
	.dc.b 	0x7C,0x06,0x06,0x7C,0x06,0x06,0x7C,0x00
	.dc.b 	0xC6,0xC6,0xC6,0x7C,0x06,0x06,0x06,0x00
	.dc.b 	0x7C,0xC0,0xC0,0x7C,0x06,0x06,0x7C,0x00
	.dc.b 	0x7C,0xC0,0xC0,0x7C,0xC6,0xC6,0x7C,0x00
	.dc.b 	0x7C,0x06,0x06,0x00,0x06,0x06,0x06,0x00
	.dc.b 	0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00
	.dc.b 	0x7C,0xC6,0xC6,0x7C,0x06,0x06,0x7C,0x00
	.dc.b 	0x00,0x00,0x3C,0x06,0x7E,0x66,0x3C,0x00
	.dc.b 	0x78,0x60,0x78,0x60,0x7E,0x18,0x1E,0x00
	.dc.b 	0x07,0x0F,0x1F,0x18,0x18,0x10,0x1E,0x17
	.dc.b 	0xF0,0xF8,0xEC,0x04,0x04,0x04,0x3C,0x54
	.dc.b 	0x11,0x0B,0x0D,0x06,0x07,0x2E,0x39,0x38
	.dc.b 	0x04,0x28,0xD8,0x28,0xD0,0x10,0xE0,0x00
	.dc.b 	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	.dc.b 	0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00
	.dc.b 	0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00
	.dc.b   0x00,0x6C,0xFE,0x6C,0x6C,0xFE,0x6C,0x00
	.dc.b   0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x00
	.dc.b   0x00,0x66,0x6C,0x18,0x30,0x66,0x46,0x00
	.dc.b   0x38,0x6C,0x38,0x70,0xDE,0xCC,0x76,0x00
	.dc.b   0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00
	.dc.b   0x0E,0x1C,0x18,0x18,0x18,0x1C,0x0E,0x00
	.dc.b   0x70,0x38,0x18,0x18,0x18,0x38,0x70,0x00
	.dc.b   0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00
	.dc.b   0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00
	.dc.b   0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x60
	.dc.b   0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00
	.dc.b   0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00
	.dc.b   0x02,0x06,0x0C,0x18,0x30,0x60,0x40,0x00
	.dc.b   0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00
	.dc.b   0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00
	.dc.b   0x3C,0x66,0x06,0x0C,0x18,0x30,0x7E,0x00
	.dc.b   0x7E,0x0C,0x18,0x0C,0x06,0x66,0x3C,0x00
	.dc.b   0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00
	.dc.b   0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00
	.dc.b   0x3C,0x60,0x60,0x7C,0x66,0x66,0x3C,0x00
	.dc.b   0x7E,0x06,0x0C,0x18,0x30,0x30,0x30,0x00
	.dc.b   0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00
	.dc.b   0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00
	.dc.b   0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00
	.dc.b   0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00
	.dc.b   0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00
	.dc.b   0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00
	.dc.b   0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00
	.dc.b   0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00
	.dc.b   0x3C,0x66,0x6E,0x6A,0x6E,0x60,0x3E,0x00
	.dc.b   0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00
	.dc.b   0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00
	.dc.b   0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00
	.dc.b   0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00
	.dc.b   0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00
	.dc.b   0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00
	.dc.b   0x3E,0x60,0x60,0x6E,0x66,0x66,0x3E,0x00
	.dc.b   0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00
	.dc.b   0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00
	.dc.b   0x06,0x06,0x06,0x06,0x06,0x66,0x3C,0x00
	.dc.b   0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00
	.dc.b   0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00
	.dc.b   0xC6,0xEE,0xFE,0xD6,0xC6,0xC6,0xC6,0x00
	.dc.b   0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00
	.dc.b   0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00
	.dc.b   0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00
	.dc.b   0x3C,0x66,0x66,0x66,0x76,0x6C,0x36,0x00
	.dc.b   0x7C,0x66,0x66,0x7C,0x6C,0x66,0x66,0x00
	.dc.b   0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00
	.dc.b   0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00
	.dc.b   0x66,0x66,0x66,0x66,0x66,0x66,0x3E,0x00
	.dc.b   0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00
	.dc.b   0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00
	.dc.b   0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00
	.dc.b   0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00
	.dc.b   0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00
	.dc.b   0x1E,0x18,0x18,0x18,0x18,0x18,0x1E,0x00
	.dc.b   0x40,0x60,0x30,0x18,0x0C,0x06,0x02,0x00
	.dc.b   0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00
	.dc.b   0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00
	.dc.b   0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00
	.dc.b   0x00,0xC0,0x60,0x30,0x00,0x00,0x00,0x00
	.dc.b   0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00
	.dc.b   0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00
	.dc.b   0x00,0x00,0x3C,0x60,0x60,0x60,0x3C,0x00
	.dc.b   0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00
	.dc.b   0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00
	.dc.b   0x1C,0x30,0x7C,0x30,0x30,0x30,0x30,0x00
	.dc.b   0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x7C
	.dc.b   0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00
	.dc.b   0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00
	.dc.b   0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x70
	.dc.b   0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00
	.dc.b   0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00
	.dc.b   0x00,0x00,0xEC,0xFE,0xD6,0xC6,0xC6,0x00
	.dc.b   0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00
	.dc.b   0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00
	.dc.b   0x00,0x00,0x7C,0x66,0x66,0x66,0x7C,0x60
	.dc.b   0x00,0x00,0x3E,0x66,0x66,0x66,0x3E,0x06
	.dc.b   0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x00
	.dc.b   0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00
	.dc.b   0x00,0x18,0x7E,0x18,0x18,0x18,0x0E,0x00
	.dc.b   0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00
	.dc.b   0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00
	.dc.b   0x00,0x00,0xC6,0xC6,0xD6,0x7C,0x6C,0x00
	.dc.b   0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00
	.dc.b   0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x7C
	.dc.b   0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00
	.dc.b   0x0E,0x18,0x18,0x30,0x18,0x18,0x0E,0x00
	.dc.b   0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18
	.dc.b   0x70,0x18,0x18,0x0C,0x18,0x18,0x70,0x00
	.dc.b   0x00,0x60,0xF2,0x9E,0x0C,0x00,0x00,0x00
	.dc.b   0x00,0x18,0x18,0x34,0x34,0x62,0x7E,0x00
        


; ===========================================================================
; ==== Bsssegment ===========================================================
; ===========================================================================
	.bss
	.even


; ===========================================================================
; ==== End ==================================================================
; ===========================================================================

	.end
